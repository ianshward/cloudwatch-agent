var sh = require('sh');

exports.definition = {
    "name": "MemoryPercentUsed",
    "namespace": "System/Linux",
    "unit": "Percent",
    "interval": 60000,
    "command": function(cb) {
        var res = {};
        sh('free -m')('grep "Mem"')('tr -s " "')('cut -d " " -f 2').result(function(total) {
            sh('free -m')('grep "buffers/cache"')('tr -s " "')('cut -d " " -f 4').result(function(free) {
                res.value = 100 - ((free * 100) / total);
                sh('wget -q -O - http://169.254.169.254/latest/meta-data/instance-id').result(function(instance) {
                    res.instance = instance;
                    cb(res);
                });
            });
        });
    }
}
